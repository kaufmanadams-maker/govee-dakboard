<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Govee Groups – Dakboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: dark;
      --bg: #050816;
      --panel: #111827;
      --panel-alt: #0b1220;
      --accent: #2563eb;
      --accent-soft: rgba(37, 99, 235, 0.15);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --error: #f97373;
      --border-subtle: #1f2937;
      --radius-lg: 18px;
      --radius-pill: 999px;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 16px;
      background: radial-gradient(circle at top, #111827 0, #020617 55%);
      color: var(--text-main);
    }

    .card {
      max-width: 520px;
      margin: 0 auto;
      padding: 18px 18px 14px;
      background: linear-gradient(135deg, #020617, #020617 40%, #111827);
      border-radius: 24px;
      box-shadow:
        0 26px 60px rgba(15, 23, 42, 0.95),
        0 0 0 1px rgba(148, 163, 184, 0.08);
      border: 1px solid rgba(148, 163, 184, 0.18);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      opacity: 0.16;
      background:
        radial-gradient(circle at 0 0, rgba(59, 130, 246, 0.65), transparent 55%),
        radial-gradient(circle at 100% 0, rgba(236, 72, 153, 0.7), transparent 55%),
        radial-gradient(circle at 0 100%, rgba(45, 212, 191, 0.6), transparent 55%);
      pointer-events: none;
      mix-blend-mode: screen;
    }

    .card-inner {
      position: relative;
      z-index: 1;
    }

    h1 {
      font-size: 1.05rem;
      letter-spacing: 0.09em;
      text-transform: uppercase;
      color: #e5e7eb;
      margin: 0 0 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .badge-api {
      margin-left: auto;
      font-size: 0.62rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-muted);
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background-color: rgba(15, 23, 42, 0.72);
      backdrop-filter: blur(6px);
      white-space: nowrap;
    }

    .subtitle {
      margin: 0 0 12px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    #statusText {
      font-size: 0.7rem;
      color: var(--text-muted);
      padding: 4px 8px;
      border-radius: 999px;
      background-color: rgba(15, 23, 42, 0.88);
      border: 1px solid rgba(55, 65, 81, 0.9);
      white-space: nowrap;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background-color: rgba(15, 23, 42, 0.8);
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .section {
      margin-top: 8px;
      padding: 10px 10px 9px;
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.98), #020617);
      border: 1px solid rgba(31, 41, 55, 0.85);
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
      margin-bottom: 6px;
    }

    .section-title {
      font-size: 0.72rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #9ca3af;
    }

    label {
      font-size: 0.7rem;
      color: var(--text-muted);
      display: block;
      margin-bottom: 4px;
    }

    input[type="password"] {
      width: 100%;
      padding: 6px 9px;
      border-radius: 10px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background-color: rgba(15, 23, 42, 0.96);
      color: var(--text-main);
      font-size: 0.78rem;
      outline: none;
    }

    input[type="password"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.7);
    }

    .btn-row {
      display: flex;
      gap: 6px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    button {
      border: none;
      border-radius: var(--radius-pill);
      padding: 6px 12px;
      font-size: 0.72rem;
      font-weight: 500;
      cursor: pointer;
      background: rgba(15, 23, 42, 0.98);
      color: var(--text-main);
      border: 1px solid rgba(55, 65, 81, 0.95);
      transition:
        background 120ms ease-out,
        transform 80ms ease-out,
        box-shadow 120ms ease-out,
        border-color 120ms ease-out;
      white-space: nowrap;
    }

    button.primary {
      background: radial-gradient(circle at top left, #3b82f6, #1d4ed8);
      border-color: rgba(96, 165, 250, 0.95);
      box-shadow:
        0 0 0 1px rgba(59, 130, 246, 0.55),
        0 14px 30px rgba(37, 99, 235, 0.6);
    }

    button.primary:hover {
      filter: brightness(1.06);
      transform: translateY(-0.5px);
    }

    button.secondary {
      background: rgba(15, 23, 42, 0.96);
    }

    button.secondary:hover {
      background: rgba(30, 64, 175, 0.45);
      border-color: rgba(96, 165, 250, 0.7);
    }

    button.danger {
      background: rgba(127, 29, 29, 0.9);
      border-color: rgba(248, 113, 113, 0.9);
      color: #fee2e2;
    }

    button.danger:hover {
      background: rgba(185, 28, 28, 0.96);
    }

    button:active {
      transform: translateY(0.4px) scale(0.99);
      box-shadow: none;
    }

    button:disabled {
      opacity: 0.45;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .controls-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 6px;
      margin-top: 4px;
      margin-bottom: 4px;
    }

    .controls-grid button {
      text-align: center;
      padding-inline: 0;
    }

    .slider-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
    }

    input[type="range"] {
      flex: 1;
      accent-color: #60a5fa;
    }

    .slider-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      width: 52px;
      text-align: left;
    }

    .slider-value {
      font-size: 0.7rem;
      color: var(--text-muted);
      width: 40px;
      text-align: right;
    }

    .color-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 8px;
    }

    input[type="color"] {
      width: 42px;
      height: 26px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      padding: 0;
      background: transparent;
      cursor: pointer;
    }

    .color-text {
      font-size: 0.7rem;
      color: var(--text-muted);
      flex: 1;
    }

    .group-card {
      margin-top: 8px;
      padding: 8px 9px 10px;
      border-radius: 14px;
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.98));
      border: 1px solid rgba(31, 41, 55, 0.9);
    }

    .group-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 4px;
    }

    .group-title {
      font-size: 0.8rem;
      color: #e5e7eb;
    }

    .group-count {
      font-size: 0.68rem;
      color: var(--text-muted);
    }

    .muted {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .footer {
      margin-top: 8px;
      font-size: 0.65rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="card-inner">
      <div class="header-row">
        <div>
          <h1>Govee Lights</h1>
          <p class="subtitle">Grouped cloud control · DakBoard</p>
        </div>
        <div class="badge-api">Cloud API · v1</div>
      </div>

      <!-- Configuration -->
      <div class="section">
        <div class="section-header">
          <div class="section-title">Configuration</div>
          <div class="pill">Stored in this browser</div>
        </div>
        <label for="apiKeyInput">Govee API Key</label>
        <input id="apiKeyInput" type="password" autocomplete="off" />
        <div class="btn-row">
          <button id="saveKeyBtn" class="primary">Save</button>
          <button id="loadDevicesBtn" class="secondary">Load devices</button>
          <button id="clearConfigBtn" class="danger">Clear config</button>
        </div>
      </div>

      <!-- Groups -->
      <div class="section">
        <div class="section-header">
          <div class="section-title">Groups</div>
          <div class="pill">Per-light group commands</div>
        </div>
        <div id="groupsContainer">
          <div class="muted">
            Load devices to populate groups.
          </div>
        </div>
      </div>

      <div class="footer">
        <div id="statusText">Idle.</div>
        <div>Per-group color/brightness fan-out</div>
      </div>
    </div>
  </div>

  <script>
    // Base URLs
    const BASE_URL = "https://openapi.api.govee.com";
    const DEVICES_URL = BASE_URL + "/router/api/v1/user/devices";
    const CONTROL_URL = BASE_URL + "/router/api/v1/device/control";
    const STATE_URL = BASE_URL + "/router/api/v1/device/state";

    // Virtual groups: only the groups you requested, with the exact order you specified.
    // Each group maps to the deviceName strings from /user/devices,
    // or to other group names (for Upstairs Lights).
    const GROUP_DEFS = {
      "Living Room": [
        "Right buzz",
        "Right couch",
        "Left couch light",
        "Buzz light year",
        "Front door light"
      ],
      "Kitchen": [
        "Kitchen garage light",
        "Right sink",
        "Left sink",
        "Right side fridge",
        "Left side stove light",
        "Dishwasher light",
        "Right of stove light"
      ],
      "Upstairs Lights": [
        "Fiona's Room",
        "Zoe's Room",
        "Playroom & Stairs"
      ],
      "Garage": [
        "Right bay 2",
        "Left bay light",
        "Right side bay 1"
      ],
      "Playroom & Stairs": [
        "Playroom 1",
        "Play room 2",
        "Over stairs 1",
        "Over stairs 2"
      ],
      "Zoe's Room": [
        "Zoe light 1",
        "Zoe light 2"
      ],
      "Fiona's Room": [
        "Fiona’s bed light",
        "Fiona’s overhead light"
      ],
      "Bedroom": [
        "Left side bed light",
        "Right side bedroom"
      ]
    };

    // Explicit render order for groups
    const GROUP_ORDER = [
      "Living Room",
      "Kitchen",
      "Upstairs Lights",
      "Garage",
      "Playroom & Stairs",
      "Zoe's Room",
      "Fiona's Room",
      "Bedroom"
    ];

    // DOM elements
    const apiKeyInput = document.getElementById("apiKeyInput");
    const saveKeyBtn = document.getElementById("saveKeyBtn");
    const clearConfigBtn = document.getElementById("clearConfigBtn");
    const loadDevicesBtn = document.getElementById("loadDevicesBtn");
    const groupsContainer = document.getElementById("groupsContainer");
    const statusText = document.getElementById("statusText");

    // Local state
    const deviceIndex = {};      // deviceName -> { device, sku, name }
    let resolvedGroups = {};     // groupName -> [ { device, sku, name } ]

    function setStatus(message, isError) {
      statusText.textContent = message;
      statusText.style.color = isError ? "#f97373" : "#9ca3af";
      statusText.style.borderColor = isError
        ? "rgba(248,113,113,0.9)"
        : "rgba(55,65,81,0.9)";
    }

    function getApiKey() {
      return apiKeyInput.value.trim();
    }

    function uuidFallback() {
      if (window.crypto && window.crypto.randomUUID) {
        return window.crypto.randomUUID();
      }
      return String(Date.now()) + "-" + Math.floor(Math.random() * 1e9);
    }

    function saveApiKeyToStorage() {
      try {
        const key = getApiKey();
        if (key) {
          localStorage.setItem("goveeApiKey", key);
          setStatus("API key saved locally.", false);
        } else {
          setStatus("Enter an API key before saving.", true);
        }
      } catch (e) {
        setStatus("Cannot save API key: " + e.message, true);
      }
    }

    function loadApiKeyFromStorage() {
      try {
        const key = localStorage.getItem("goveeApiKey");
        if (key) {
          apiKeyInput.value = key;
          setStatus("API key loaded from local storage.", false);
        }
      } catch {
        // ignore
      }
    }

    function clearConfig() {
      try {
        localStorage.removeItem("goveeApiKey");
      } catch {
        // ignore
      }
      apiKeyInput.value = "";
      resolvedGroups = {};
      groupsContainer.innerHTML =
        '<div class="muted">Config cleared. Load devices again after setting API key.</div>';
      setStatus("Config cleared.", false);
    }

    function escapeHtml(text) {
      if (text == null) return "";
      return String(text)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }

    function buildResolvedGroups(devices) {
      // Index individual lights by deviceName for quick lookup
      for (const d of devices) {
        if (!d || !d.deviceName || !d.device || !d.sku) continue;
        if (d.type && d.type !== "devices.types.light") continue;
        const name = d.deviceName.trim();
        deviceIndex[name] = {
          device: d.device,
          sku: d.sku,
          name
        };
      }

      resolvedGroups = {};

      function resolveGroup(name, stack) {
        if (resolvedGroups[name]) return resolvedGroups[name];
        const defs = GROUP_DEFS[name];
        if (!defs) return [];
        if (stack.includes(name)) {
          console.warn("Circular group reference detected:", stack, "->", name);
          return [];
        }
        const nextStack = stack.concat(name);
        const out = [];

        for (const token of defs) {
          const devEntry = deviceIndex[token];
          if (devEntry) {
            if (!out.some(d => d.device === devEntry.device && d.sku === devEntry.sku)) {
              out.push(devEntry);
            }
            continue;
          }
          if (GROUP_DEFS[token]) {
            const nested = resolveGroup(token, nextStack);
            for (const nd of nested) {
              if (!out.some(d => d.device === nd.device && d.sku === nd.sku)) {
                out.push(nd);
              }
            }
          } else {
            // Unknown token; ignore silently
          }
        }

        resolvedGroups[name] = out;
        return out;
      }

      Object.keys(GROUP_DEFS).forEach(groupName => {
        const devicesForGroup = resolveGroup(groupName, []);
        if (!devicesForGroup || !devicesForGroup.length) {
          delete resolvedGroups[groupName];
        }
      });
    }

    function renderGroupsUI() {
      const available = Object.keys(resolvedGroups);
      if (!available.length) {
        groupsContainer.innerHTML =
          '<div class="muted">No mapped groups found. Check device names and GROUP_DEFS.</div>';
        return;
      }

      let html = "";
      for (const groupName of GROUP_ORDER) {
        const groupDevices = resolvedGroups[groupName];
        if (!groupDevices || !groupDevices.length) continue;

        const safeGroup = escapeHtml(groupName);
        const countLabel = groupDevices.length === 1
          ? "1 light"
          : groupDevices.length + " lights";

        html += `
          <div class="group-card" data-group="${safeGroup}">
            <div class="group-header">
              <div class="group-title">${safeGroup}</div>
              <div class="group-count">${escapeHtml(countLabel)}</div>
            </div>

            <div class="controls-grid">
              <button class="primary btn-on" data-group="${safeGroup}">On</button>
              <button class="secondary btn-off" data-group="${safeGroup}">Off</button>
              <button class="secondary btn-refresh" data-group="${safeGroup}">Refresh</button>
            </div>

            <div class="slider-row">
              <div class="slider-label">Brightness</div>
              <input
                type="range"
                class="brightness-range"
                data-group="${safeGroup}"
                min="1"
                max="100"
                value="100"
              />
              <span class="slider-value" data-group="${safeGroup}">100%</span>
            </div>
            <div class="btn-row" style="margin-top:4px;">
              <button class="secondary btn-set-brightness" data-group="${safeGroup}" style="flex:1">
                Set brightness
              </button>
            </div>

            <div class="color-row">
              <div class="slider-label">Color</div>
              <input
                type="color"
                class="color-picker"
                data-group="${safeGroup}"
                value="#ffffff"
              />
              <div class="color-text">Picking a color updates the group</div>
            </div>
          </div>
        `;
      }

      groupsContainer.innerHTML = html;
    }

    async function loadDevices() {
      const apiKey = getApiKey();
      if (!apiKey) {
        setStatus("Enter your Govee API key first.", true);
        return;
      }

      setStatus("Loading devices…", false);
      groupsContainer.innerHTML =
        '<div class="muted">Loading devices from Govee…</div>';

      try {
        const res = await fetch(DEVICES_URL, {
          method: "GET",
          headers: {
            "Govee-API-Key": apiKey
          }
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error("HTTP " + res.status + " " + text);
        }

        const data = await res.json();
        const code = data.code;
        if (code !== 200) {
          throw new Error(
            "API error code " + code + ": " + (data.msg || data.message || "unknown")
          );
        }

        const devices = data.data || [];
        if (!devices.length) {
          groupsContainer.innerHTML =
            '<div class="muted">No devices returned from API.</div>';
          setStatus("No devices returned from API.", true);
          return;
        }

        // Build device index and resolved groups, then render UI
        for (const k of Object.keys(deviceIndex)) {
          delete deviceIndex[k];
        }
        buildResolvedGroups(devices);
        renderGroupsUI();

        const groupCount = Object.keys(resolvedGroups).length;
        if (!groupCount) {
          setStatus("Devices loaded, but no groups matched.", true);
        } else {
          setStatus("Devices loaded. Refreshing group states…", false);
          await refreshAllGroups(); // Auto-refresh all groups after load
        }
      } catch (e) {
        console.error(e);
        groupsContainer.innerHTML =
          '<div class="muted">Error loading devices: ' + escapeHtml(e.message) + '</div>';
        setStatus("Device load failed: " + e.message, true);
      }
    }

    async function sendControlToDevice(deviceEntry, capability, apiKey) {
      const res = await fetch(CONTROL_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Govee-API-Key": apiKey
        },
        body: JSON.stringify({
          requestId: uuidFallback(),
          payload: {
            device: deviceEntry.device,
            sku: deviceEntry.sku,
            capability
          }
        })
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error("HTTP " + res.status + " " + text);
      }

      const data = await res.json();
      if (data.code !== 200) {
        throw new Error(
          "API error code " + data.code + ": " + (data.msg || data.message || "unknown")
        );
      }
    }

    async function sendGroupControl(groupName, capability) {
      const apiKey = getApiKey();
      if (!apiKey) {
        setStatus("Enter your Govee API key first.", true);
        return;
      }

      const devicesForGroup = resolvedGroups[groupName];
      if (!devicesForGroup || !devicesForGroup.length) {
        setStatus('No devices mapped for group "' + groupName + '".', true);
        return;
      }

      setStatus(
        "Sending command to " + groupName + " (" + devicesForGroup.length + " lights)…",
        false
      );

      try {
        await Promise.all(
          devicesForGroup.map(dev => sendControlToDevice(dev, capability, apiKey))
        );
        setStatus(
          "Command sent to " + groupName + " (" + devicesForGroup.length + " lights).",
          false
        );
      } catch (e) {
        console.error(e);
        setStatus("Command failed for " + groupName + ": " + e.message, true);
      }
    }

    function getGroupCard(groupName) {
      return groupsContainer.querySelector(
        '.group-card[data-group="' + groupName.replace(/"/g, '&quot;') + '"]'
      );
    }

    async function refreshGroupState(groupName) {
      const apiKey = getApiKey();
      if (!apiKey) {
        setStatus("Enter your Govee API key first.", true);
        return;
      }

      const devicesForGroup = resolvedGroups[groupName];
      if (!devicesForGroup || !devicesForGroup.length) {
        setStatus('No devices mapped for group "' + groupName + '".', true);
        return;
      }

      const sample = devicesForGroup[0];
      const card = getGroupCard(groupName);

      setStatus("Refreshing state from " + groupName + "…", false);

      try {
        const res = await fetch(STATE_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Govee-API-Key": apiKey
          },
          body: JSON.stringify({
            requestId: uuidFallback(),
            payload: {
              device: sample.device,
              sku: sample.sku
            }
          })
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error("HTTP " + res.status + " " + text);
        }

        const data = await res.json();
        if (data.code !== 200) {
          throw new Error(
            "API error code " + data.code + ": " + (data.msg || data.message || "unknown")
          );
        }

        const caps = (data.payload && data.payload.capabilities) || [];

        const powerCap = caps.find(
          c =>
            c.type === "devices.capabilities.on_off" &&
            c.instance === "powerSwitch"
        );
        if (powerCap && powerCap.state) {
          const val = powerCap.state.value;
          setStatus(
            groupName + " state: " + (val ? "On" : "Off") + " · refreshed.",
            false
          );
        } else {
          setStatus(groupName + " state refreshed.", false);
        }

        const brightCap = caps.find(
          c =>
            c.type === "devices.capabilities.range" &&
            c.instance === "brightness"
        );
        if (
          brightCap &&
          brightCap.state &&
          typeof brightCap.state.value === "number" &&
          card
        ) {
          const v = brightCap.state.value;
          const rangeEl = card.querySelector(".brightness-range");
          const valEl = card.querySelector(".slider-value");
          if (rangeEl) rangeEl.value = v;
          if (valEl) valEl.textContent = v + "%";
        }

        const colorCap = caps.find(
          c =>
            c.type === "devices.capabilities.color_setting" &&
            c.instance === "colorRgb"
        );
        if (
          colorCap &&
          colorCap.state &&
          typeof colorCap.state.value === "number" &&
          card
        ) {
          const rgbInt = colorCap.state.value;
          const r = (rgbInt >> 16) & 255;
          const g = (rgbInt >> 8) & 255;
          const b = rgbInt & 255;
          const hex =
            "#" +
            [r, g, b]
              .map(x => x.toString(16).padStart(2, "0"))
              .join("");
          const colorEl = card.querySelector(".color-picker");
          if (colorEl) colorEl.value = hex;
        }
      } catch (e) {
        console.error(e);
        setStatus("State refresh failed for " + groupName + ": " + e.message, true);
      }
    }

    async function refreshAllGroups() {
      const names = GROUP_ORDER.filter(name => resolvedGroups[name]);
      for (const name of names) {
        await refreshGroupState(name);
      }
      if (names.length) {
        setStatus("All group states refreshed.", false);
      }
    }

    // Event wiring

    loadApiKeyFromStorage();

    saveKeyBtn.addEventListener("click", saveApiKeyToStorage);
    clearConfigBtn.addEventListener("click", clearConfig);
    loadDevicesBtn.addEventListener("click", loadDevices);

    // Event delegation for all group controls (click)
    groupsContainer.addEventListener("click", function (e) {
      const target = e.target;
      if (!(target instanceof HTMLElement)) return;

      const groupName = target.dataset.group;
      if (!groupName) return;

      if (target.classList.contains("btn-on")) {
        sendGroupControl(groupName, {
          type: "devices.capabilities.on_off",
          instance: "powerSwitch",
          value: 1
        });
      } else if (target.classList.contains("btn-off")) {
        sendGroupControl(groupName, {
          type: "devices.capabilities.on_off",
          instance: "powerSwitch",
          value: 0
        });
      } else if (target.classList.contains("btn-refresh")) {
        refreshGroupState(groupName);
      } else if (target.classList.contains("btn-set-brightness")) {
        const card = target.closest(".group-card");
        if (!card) return;
        const rangeEl = card.querySelector(".brightness-range");
        if (!rangeEl) return;
        const val = Math.max(
          1,
          Math.min(100, parseInt(rangeEl.value, 10) || 1)
        );
        sendGroupControl(groupName, {
          type: "devices.capabilities.range",
          instance: "brightness",
          value: val
        });
      }
    });

    // Event delegation for slider + color changes
    groupsContainer.addEventListener("input", function (e) {
      const target = e.target;
      if (!(target instanceof HTMLElement)) return;

      if (target.classList.contains("brightness-range")) {
        const card = target.closest(".group-card");
        if (!card) return;
        const valEl = card.querySelector(".slider-value");
        if (!valEl) return;
        valEl.textContent = target.value + "%";
      }
    });

    // Color picker change -> update group color
    groupsContainer.addEventListener("change", function (e) {
      const target = e.target;
      if (!(target instanceof HTMLElement)) return;
      if (!target.classList.contains("color-picker")) return;

      const groupName = target.dataset.group;
      if (!groupName) return;

      const hex = target.value || "#ffffff";
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      const rgbInt = (r << 16) + (g << 8) + b;

      sendGroupControl(groupName, {
        type: "devices.capabilities.color_setting",
        instance: "colorRgb",
        value: rgbInt
      });
    });
  </script>
</body>
</html>

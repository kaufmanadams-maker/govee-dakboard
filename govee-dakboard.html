<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Govee Lights – Groups</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: dark;
      --bg: #050816;
      --panel: #111827;
      --panel-alt: #0b1220;
      --accent: #2563eb;
      --accent-soft: rgba(37, 99, 235, 0.15);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --error: #f97373;
      --border-subtle: #1f2937;
      --radius-lg: 18px;
      --radius-pill: 999px;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 16px;
      background: radial-gradient(circle at top, #111827 0, #020617 55%);
      color: var(--text-main);
    }

    .card {
      max-width: 480px;
      margin: 0 auto;
      padding: 18px 18px 14px;
      background: linear-gradient(135deg, #020617, #020617 40%, #111827);
      border-radius: 24px;
      box-shadow:
        0 26px 60px rgba(15, 23, 42, 0.95),
        0 0 0 1px rgba(148, 163, 184, 0.08);
      border: 1px solid rgba(148, 163, 184, 0.18);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      opacity: 0.16;
      background:
        radial-gradient(circle at 0 0, rgba(59, 130, 246, 0.65), transparent 55%),
        radial-gradient(circle at 100% 0, rgba(236, 72, 153, 0.7), transparent 55%),
        radial-gradient(circle at 0 100%, rgba(45, 212, 191, 0.6), transparent 55%);
      pointer-events: none;
      mix-blend-mode: screen;
    }

    .card-inner {
      position: relative;
      z-index: 1;
    }

    h1 {
      font-size: 1.05rem;
      letter-spacing: 0.09em;
      text-transform: uppercase;
      color: #e5e7eb;
      margin: 0 0 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .badge-api {
      margin-left: auto;
      font-size: 0.62rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-muted);
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background-color: rgba(15, 23, 42, 0.72);
      backdrop-filter: blur(6px);
      white-space: nowrap;
    }

    .subtitle {
      margin: 0 0 12px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .section {
      margin-top: 8px;
      padding: 10px 10px 9px;
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.98), #020617);
      border: 1px solid rgba(31, 41, 55, 0.85);
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
      margin-bottom: 6px;
    }

    .section-title {
      font-size: 0.72rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #9ca3af;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background-color: rgba(15, 23, 42, 0.8);
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    label {
      font-size: 0.7rem;
      color: var(--text-muted);
      display: block;
      margin-bottom: 4px;
    }

    input[type="password"],
    select {
      width: 100%;
      padding: 6px 9px;
      border-radius: 10px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background-color: rgba(15, 23, 42, 0.96);
      color: var(--text-main);
      font-size: 0.78rem;
      outline: none;
    }

    input[type="password"]:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.7);
    }

    .btn-row {
      display: flex;
      gap: 6px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    button {
      border: none;
      border-radius: var(--radius-pill);
      padding: 6px 12px;
      font-size: 0.72rem;
      font-weight: 500;
      cursor: pointer;
      background: rgba(15, 23, 42, 0.98);
      color: var(--text-main);
      border: 1px solid rgba(55, 65, 81, 0.95);
      transition:
        background 120ms ease-out,
        transform 80ms ease-out,
        box-shadow 120ms ease-out,
        border-color 120ms ease-out;
      white-space: nowrap;
    }

    button.primary {
      background: radial-gradient(circle at top left, #3b82f6, #1d4ed8);
      border-color: rgba(96, 165, 250, 0.95);
      box-shadow:
        0 0 0 1px rgba(59, 130, 246, 0.55),
        0 14px 30px rgba(37, 99, 235, 0.6);
    }

    button.primary:hover {
      filter: brightness(1.06);
      transform: translateY(-0.5px);
    }

    button.secondary {
      background: rgba(15, 23, 42, 0.96);
    }

    button.secondary:hover {
      background: rgba(30, 64, 175, 0.45);
      border-color: rgba(96, 165, 250, 0.7);
    }

    button.danger {
      background: rgba(127, 29, 29, 0.9);
      border-color: rgba(248, 113, 113, 0.9);
      color: #fee2e2;
    }

    button.danger:hover {
      background: rgba(185, 28, 28, 0.96);
    }

    button:active {
      transform: translateY(0.4px) scale(0.99);
      box-shadow: none;
    }

    button:disabled {
      opacity: 0.45;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .target-mode-row {
      display: flex;
      gap: 10px;
      margin-bottom: 6px;
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .target-mode-row label {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 0;
      cursor: pointer;
    }

    .target-select-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
    }

    .controls-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 6px;
      margin-top: 4px;
      margin-bottom: 4px;
    }

    .controls-grid button {
      text-align: center;
      padding-inline: 0;
    }

    .slider-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
    }

    input[type="range"] {
      flex: 1;
      accent-color: #60a5fa;
    }

    .slider-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      width: 60px;
      text-align: left;
    }

    .slider-value {
      font-size: 0.7rem;
      color: var(--text-muted);
      width: 42px;
      text-align: right;
    }

    .color-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 6px;
    }

    input[type="color"] {
      width: 38px;
      height: 22px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      padding: 0;
      background: transparent;
      cursor: pointer;
    }

    #statusText {
      font-size: 0.7rem;
      color: var(--text-muted);
      padding: 4px 8px;
      border-radius: 999px;
      background-color: rgba(15, 23, 42, 0.88);
      border: 1px solid rgba(55, 65, 81, 0.9);
      white-space: nowrap;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .footer {
      margin-top: 8px;
      font-size: 0.65rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      opacity: 0.8;
    }

    .footer small {
      opacity: 0.9;
    }

    .muted {
      opacity: 0.6;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="card-inner">
      <div class="header-row">
        <div>
          <h1>Govee Lights</h1>
          <p class="subtitle">Dakboard · Device / Group control</p>
        </div>
        <div class="badge-api">Cloud API · v1</div>
      </div>

      <!-- Configuration -->
      <div class="section">
        <div class="section-header">
          <div class="section-title">Configuration</div>
          <div class="pill">Stored in this browser</div>
        </div>
        <label for="apiKeyInput">Govee API Key</label>
        <input id="apiKeyInput" type="password" autocomplete="off" />
        <div class="btn-row">
          <button id="saveKeyBtn" class="primary">Save</button>
          <button id="loadDevicesBtn" class="secondary">Load devices</button>
          <button id="clearConfigBtn" class="danger">Clear config</button>
        </div>
      </div>

      <!-- Target selection: device vs group -->
      <div class="section">
        <div class="section-header">
          <div class="section-title">Target</div>
          <div class="pill">Choose device or group</div>
        </div>

        <div class="target-mode-row">
          <label>
            <input type="radio" name="targetMode" value="device" checked />
            Device
          </label>
          <label>
            <input type="radio" name="targetMode" value="group" />
            Group
          </label>
        </div>

        <div class="target-select-row">
          <div>
            <label for="deviceSelect">Device</label>
            <select id="deviceSelect">
              <option value="">Select a device…</option>
            </select>
          </div>
          <div>
            <label for="groupSelect">Group</label>
            <select id="groupSelect" disabled>
              <option value="">Select a group…</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Controls -->
      <div class="section">
        <div class="section-header">
          <div class="section-title">Controls</div>
          <div class="pill">Power · Brightness · Color</div>
        </div>

        <div class="controls-grid">
          <button id="onBtn" class="primary">On</button>
          <button id="offBtn" class="secondary">Off</button>
          <button id="refreshBtn" class="secondary">Refresh</button>
        </div>

        <div class="slider-row">
          <div class="slider-label">Brightness</div>
          <input id="brightnessRange" type="range" min="1" max="100" value="100" />
          <span class="slider-value" id="brightnessValue">100%</span>
        </div>
        <div class="btn-row">
          <button id="setBrightnessBtn" class="secondary" style="flex: 1">
            Set brightness
          </button>
        </div>

        <div class="color-row">
          <div class="slider-label">Color</div>
          <input id="colorPicker" type="color" value="#ffffff" />
          <button id="setColorBtn" class="secondary" style="flex: 1">
            Set color
          </button>
        </div>
      </div>

      <div class="footer">
        <div id="statusText">Idle.</div>
        <small class="muted">Groups simulated via per-light control</small>
      </div>
    </div>
  </div>

  <script>
    // Static virtual groups based on your mapping.
    // Names in the arrays must match deviceName from /user/devices.
    const VIRTUAL_GROUPS = {
      "Bedroom": [
        "Left side bed light",
        "Right side bedroom"
      ],
      "Kitchen": [
        "Kitchen garage light",
        "Right sink",
        "Left sink",
        "Right side fridge",
        "Left side stove light",
        "Dishwasher light",
        "Right of stove light"
      ],
      "Garage": [
        "Right bay 2",
        "Left bay light",
        "Right side bay 1"
      ],
      "Living Room": [
        "Right buzz",
        "Right couch",
        "Left couch light",
        "Buzz light year",
        "Front door light"
      ],
      "Zoe's Room": [
        "Zoe light 1",
        "Zoe light 2"
      ],
      "Playroom & Stairs": [
        "Playroom 1",
        "Play room 2",
        "Over stairs 1",
        "Over stairs 2"
      ],
      "Fiona's Room": [
        "Fiona\u2019s bed light",
        "Fiona\u2019s overhead light"
      ],
      "Upstairs Lights": [
        "Zoe's Room",
        "Fiona's Room",
        "Playroom & Stairs"
      ],
      "Downstairs Lights": [
        "Kitchen",
        "Living Room"
      ]
    };

    const BASE_URL = "https://openapi.api.govee.com";
    const DEVICES_URL = BASE_URL + "/router/api/v1/user/devices";
    const CONTROL_URL = BASE_URL + "/router/api/v1/device/control";
    const STATE_URL = BASE_URL + "/router/api/v1/device/state";

    // DOM elements
    const apiKeyInput = document.getElementById("apiKeyInput");
    const saveKeyBtn = document.getElementById("saveKeyBtn");
    const clearConfigBtn = document.getElementById("clearConfigBtn");
    const loadDevicesBtn = document.getElementById("loadDevicesBtn");

    const deviceSelect = document.getElementById("deviceSelect");
    const groupSelect = document.getElementById("groupSelect");
    const targetModeRadios = document.querySelectorAll("input[name='targetMode']");

    const onBtn = document.getElementById("onBtn");
    const offBtn = document.getElementById("offBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const brightnessRange = document.getElementById("brightnessRange");
    const brightnessValue = document.getElementById("brightnessValue");
    const setBrightnessBtn = document.getElementById("setBrightnessBtn");
    const colorPicker = document.getElementById("colorPicker");
    const setColorBtn = document.getElementById("setColorBtn");

    const statusText = document.getElementById("statusText");

    // State
    let allDevices = [];
    let resolvedGroups = {};
    let targetMode = "device"; // "device" | "group"

    function setStatus(message, isError) {
      statusText.textContent = message;
      statusText.style.color = isError ? "#f97373" : "#9ca3af";
      statusText.style.borderColor = isError
        ? "rgba(248,113,113,0.9)"
        : "rgba(55,65,81,0.9)";
    }

    function getApiKey() {
      return apiKeyInput.value.trim();
    }

    function uuidFallback() {
      if (window.crypto && window.crypto.randomUUID) {
        return window.crypto.randomUUID();
      }
      return String(Date.now()) + "-" + Math.floor(Math.random() * 1e9);
    }

    function saveApiKeyToStorage() {
      try {
        const key = getApiKey();
        if (key) {
          localStorage.setItem("goveeApiKey", key);
          setStatus("API key saved locally.", false);
        } else {
          setStatus("Enter an API key before saving.", true);
        }
      } catch (e) {
        setStatus("Cannot save API key: " + e.message, true);
      }
    }

    function loadApiKeyFromStorage() {
      try {
        const key = localStorage.getItem("goveeApiKey");
        if (key) {
          apiKeyInput.value = key;
          setStatus("API key loaded from local storage.", false);
        }
      } catch {
        // ignore
      }
    }

    function clearConfig() {
      try {
        localStorage.removeItem("goveeApiKey");
      } catch {
        // ignore
      }
      apiKeyInput.value = "";
      deviceSelect.innerHTML =
        '<option value="">Select a device…</option>';
      groupSelect.innerHTML =
        '<option value="">Select a group…</option>';
      groupSelect.disabled = true;
      resolvedGroups = {};
      allDevices = [];
      setStatus("Config cleared.", false);
    }

    function updateTargetModeUI() {
      if (targetMode === "device") {
        deviceSelect.disabled = false;
        groupSelect.disabled = true;
      } else {
        deviceSelect.disabled = true;
        groupSelect.disabled = false;
      }
    }

    function buildDeviceSelect(devices) {
      const physicalDevices = devices.filter(d => d.sku !== "SameModeGroup");

      deviceSelect.innerHTML =
        '<option value="">Select a device…</option>';

      physicalDevices.forEach(d => {
        const opt = document.createElement("option");
        opt.value = JSON.stringify({
          device: d.device,
          sku: d.sku,
          name: d.deviceName
        });
        opt.textContent = d.deviceName
          ? d.deviceName + " (" + d.sku + ")"
          : d.sku;
        deviceSelect.appendChild(opt);
      });
    }

    function buildResolvedGroups(devices) {
      const nameIndex = {};
      devices.forEach(d => {
        // Only physical lights (not SameModeGroup)
        if (d.sku !== "SameModeGroup") {
          nameIndex[d.deviceName] = {
            device: d.device,
            sku: d.sku,
            name: d.deviceName
          };
        }
      });

      const cache = {};
      resolvedGroups = {};

      function expandGroup(groupName, stack) {
        if (cache[groupName]) return cache[groupName];
        if (stack.includes(groupName)) {
          console.warn("Circular group reference detected:", groupName);
          return [];
        }
        const members = VIRTUAL_GROUPS[groupName] || [];
        const out = [];
        stack.push(groupName);

        members.forEach(item => {
          if (Object.prototype.hasOwnProperty.call(VIRTUAL_GROUPS, item)) {
            // Nested group reference
            out.push(...expandGroup(item, stack));
          } else if (Object.prototype.hasOwnProperty.call(nameIndex, item)) {
            out.push(nameIndex[item]);
          } else {
            console.warn("Unknown group member:", item, "in group", groupName);
          }
        });

        stack.pop();

        // Deduplicate by device|sku
        const seen = {};
        const dedup = [];
        out.forEach(dev => {
          const key = dev.device + "|" + dev.sku;
          if (!seen[key]) {
            seen[key] = true;
            dedup.push(dev);
          }
        });

        cache[groupName] = dedup;
        return dedup;
      }

      Object.keys(VIRTUAL_GROUPS).forEach(groupName => {
        const devicesInGroup = expandGroup(groupName, []);
        if (devicesInGroup && devicesInGroup.length) {
          resolvedGroups[groupName] = devicesInGroup;
        }
      });

      // Populate group selector
      groupSelect.innerHTML = '<option value="">Select a group…</option>';
      Object.keys(resolvedGroups).forEach(name => {
        const devs = resolvedGroups[name];
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name + " (" + devs.length + ")";
        groupSelect.appendChild(opt);
      });

      if (Object.keys(resolvedGroups).length) {
        groupSelect.disabled = (targetMode !== "group");
      } else {
        groupSelect.disabled = true;
      }
    }

    async function loadDevices() {
      const apiKey = getApiKey();
      if (!apiKey) {
        setStatus("Enter your Govee API key first.", true);
        return;
      }

      setStatus("Loading devices…", false);
      deviceSelect.innerHTML =
        '<option value="">Loading…</option>';
      groupSelect.innerHTML =
        '<option value="">Select a group…</option>';
      groupSelect.disabled = true;

      try {
        const res = await fetch(DEVICES_URL, {
          method: "GET",
          headers: {
            "Govee-API-Key": apiKey
          }
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error("HTTP " + res.status + " " + text);
        }

        const data = await res.json();
        if (data.code !== 200) {
          throw new Error(
            "API error code " + data.code + ": " + (data.msg || data.message || "unknown")
          );
        }

        const devices = data.data || [];
        if (!devices.length) {
          deviceSelect.innerHTML =
            '<option value="">No devices found.</option>';
          setStatus("No devices returned from API.", true);
          return;
        }

        allDevices = devices;
        buildDeviceSelect(allDevices);
        buildResolvedGroups(allDevices);

        setStatus("Devices loaded. Groups resolved.", false);
      } catch (e) {
        console.error(e);
        deviceSelect.innerHTML =
          '<option value="">Error loading devices</option>';
        groupSelect.innerHTML =
          '<option value="">Select a group…</option>';
        groupSelect.disabled = true;
        setStatus("Device load failed: " + e.message, true);
      }
    }

    function getSelectedDevice() {
      const value = deviceSelect.value;
      if (!value) return null;
      try {
        return JSON.parse(value);
      } catch {
        return null;
      }
    }

    function getSelectedGroupName() {
      const value = groupSelect.value;
      return value || null;
    }

    async function doControlRequest(deviceId, sku, capability, apiKey, quiet) {
      if (!quiet) {
        setStatus("Sending command…", false);
      }

      const res = await fetch(CONTROL_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Govee-API-Key": apiKey
        },
        body: JSON.stringify({
          requestId: uuidFallback(),
          payload: {
            device: deviceId,
            sku: sku,
            capability
          }
        })
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error("HTTP " + res.status + " " + text);
      }

      const data = await res.json();
      if (data.code !== 200) {
        throw new Error(
          "API error code " + data.code + ": " + (data.msg || data.message || "unknown")
        );
      }

      return true;
    }

    async function sendDeviceControl(capability) {
      const apiKey = getApiKey();
      if (!apiKey) {
        setStatus("Enter your Govee API key first.", true);
        return;
      }
      const sel = getSelectedDevice();
      if (!sel) {
        setStatus("Select a device first.", true);
        return;
      }

      try {
        await doControlRequest(sel.device, sel.sku, capability, apiKey, false);
        setStatus("Command sent to device.", false);
      } catch (e) {
        console.error(e);
        setStatus("Device command failed: " + e.message, true);
      }
    }

    async function sendGroupControl(capability) {
      const apiKey = getApiKey();
      if (!apiKey) {
        setStatus("Enter your Govee API key first.", true);
        return;
      }
      const groupName = getSelectedGroupName();
      if (!groupName) {
        setStatus("Select a group first.", true);
        return;
      }
      const devices = resolvedGroups[groupName] || [];
      if (!devices.length) {
        setStatus("No devices mapped for group.", true);
        return;
      }

      setStatus("Sending to " + devices.length + " lights…", false);

      try {
        const results = await Promise.allSettled(
          devices.map(d =>
            doControlRequest(d.device, d.sku, capability, apiKey, true)
          )
        );
        const ok = results.filter(r => r.status === "fulfilled").length;
        const fail = results.length - ok;
        if (fail) {
          setStatus(
            "Group command: " + ok + " ok, " + fail + " failed.",
            true
          );
        } else {
          setStatus("Group command sent to " + ok + " lights.", false);
        }
      } catch (e) {
        console.error(e);
        setStatus("Group command failed: " + e.message, true);
      }
    }

    async function applyCapabilityToTarget(capability) {
      if (targetMode === "device") {
        await sendDeviceControl(capability);
      } else {
        await sendGroupControl(capability);
      }
    }

    async function refreshTargetState() {
      if (targetMode === "group") {
        setStatus("Refresh is for individual devices only. Switch to Device target.", false);
        return;
      }

      const apiKey = getApiKey();
      if (!apiKey) {
        setStatus("Enter your Govee API key first.", true);
        return;
      }
      const sel = getSelectedDevice();
      if (!sel) {
        setStatus("Select a device first.", true);
        return;
      }

      setStatus("Refreshing device state…", false);

      try {
        const res = await fetch(STATE_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Govee-API-Key": apiKey
          },
          body: JSON.stringify({
            requestId: uuidFallback(),
            payload: {
              device: sel.device,
              sku: sel.sku
            }
          })
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error("HTTP " + res.status + " " + text);
        }

        const data = await res.json();
        if (data.code !== 200) {
          throw new Error(
            "API error code " + data.code + ": " + (data.msg || data.message || "unknown")
          );
        }

        const caps = (data.payload && data.payload.capabilities) || [];

        const brightCap = caps.find(
          c =>
            c.type === "devices.capabilities.range" &&
            c.instance === "brightness" &&
            c.state &&
            typeof c.state.value === "number"
        );
        if (brightCap) {
          const v = Math.max(1, Math.min(100, Math.round(brightCap.state.value)));
          brightnessRange.value = v;
          brightnessValue.textContent = v + "%";
        }

        const colorCap = caps.find(
          c =>
            c.type === "devices.capabilities.color_setting" &&
            c.instance === "colorRgb" &&
            c.state &&
            typeof c.state.value === "number"
        );
        if (colorCap) {
          const rgbInt = colorCap.state.value;
          const r = (rgbInt >> 16) & 255;
          const g = (rgbInt >> 8) & 255;
          const b = rgbInt & 255;
          const hex =
            "#" +
            [r, g, b]
              .map(x => x.toString(16).padStart(2, "0"))
              .join("");
          colorPicker.value = hex;
        }

        setStatus("Device state refreshed.", false);
      } catch (e) {
        console.error(e);
        setStatus("State refresh failed: " + e.message, true);
      }
    }

    // Event wiring
    brightnessRange.addEventListener("input", () => {
      brightnessValue.textContent = brightnessRange.value + "%";
    });

    saveKeyBtn.addEventListener("click", saveApiKeyToStorage);
    clearConfigBtn.addEventListener("click", clearConfig);
    loadDevicesBtn.addEventListener("click", loadDevices);

    targetModeRadios.forEach(radio => {
      radio.addEventListener("change", () => {
        targetMode = radio.value;
        updateTargetModeUI();
      });
    });

    onBtn.addEventListener("click", () =>
      applyCapabilityToTarget({
        type: "devices.capabilities.on_off",
        instance: "powerSwitch",
        value: 1
      })
    );

    offBtn.addEventListener("click", () =>
      applyCapabilityToTarget({
        type: "devices.capabilities.on_off",
        instance: "powerSwitch",
        value: 0
      })
    );

    refreshBtn.addEventListener("click", refreshTargetState);

    setBrightnessBtn.addEventListener("click", () => {
      let v = parseInt(brightnessRange.value, 10);
      if (isNaN(v)) v = 100;
      v = Math.max(1, Math.min(100, v));
      applyCapabilityToTarget({
        type: "devices.capabilities.range",
        instance: "brightness",
        value: v
      });
    });

    setColorBtn.addEventListener("click", () => {
      const hex = colorPicker.value || "#ffffff";
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      const rgbInt = (r << 16) + (g << 8) + b;
      applyCapabilityToTarget({
        type: "devices.capabilities.color_setting",
        instance: "colorRgb",
        value: rgbInt
      });
    });

    // Init
    loadApiKeyFromStorage();
    updateTargetModeUI();
  </script>
</body>
</html>

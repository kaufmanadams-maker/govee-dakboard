<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Govee Groups – DakBoard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: dark;
      --bg: #050816;
      --panel: #111827;
      --accent: #2563eb;
      --accent-soft: rgba(37, 99, 235, 0.15);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --error: #f97373;
      --border-subtle: #1f2937;
      --radius-lg: 18px;
      --radius-pill: 999px;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 16px;
      background: radial-gradient(circle at top, #111827 0, #020617 55%);
      color: var(--text-main);
    }

    .card {
      max-width: 480px;
      margin: 0 auto;
      padding: 18px 18px 14px;
      background: linear-gradient(135deg, #020617, #020617 40%, #111827);
      border-radius: 24px;
      box-shadow:
        0 26px 60px rgba(15, 23, 42, 0.95),
        0 0 0 1px rgba(148, 163, 184, 0.08);
      border: 1px solid rgba(148, 163, 184, 0.18);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      opacity: 0.16;
      background:
        radial-gradient(circle at 0 0, rgba(59, 130, 246, 0.65), transparent 55%),
        radial-gradient(circle at 100% 0, rgba(236, 72, 153, 0.7), transparent 55%),
        radial-gradient(circle at 0 100%, rgba(45, 212, 191, 0.6), transparent 55%);
      pointer-events: none;
      mix-blend-mode: screen;
    }

    .card-inner {
      position: relative;
      z-index: 1;
    }

    h1 {
      font-size: 1.05rem;
      letter-spacing: 0.09em;
      text-transform: uppercase;
      color: #e5e7eb;
      margin: 0 0 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .badge-api {
      margin-left: auto;
      font-size: 0.62rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-muted);
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background-color: rgba(15, 23, 42, 0.72);
      backdrop-filter: blur(6px);
      white-space: nowrap;
    }

    .subtitle {
      margin: 0 0 12px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    #statusText {
      font-size: 0.7rem;
      color: var(--text-muted);
      padding: 4px 8px;
      border-radius: 999px;
      background-color: rgba(15, 23, 42, 0.88);
      border: 1px solid rgba(55, 65, 81, 0.9);
      white-space: nowrap;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background-color: rgba(15, 23, 42, 0.8);
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .section {
      margin-top: 8px;
      padding: 10px 10px 9px;
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.98), #020617);
      border: 1px solid rgba(31, 41, 55, 0.85);
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
      margin-bottom: 6px;
    }

    .section-title {
      font-size: 0.72rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #9ca3af;
    }

    label {
      font-size: 0.7rem;
      color: var(--text-muted);
      display: block;
      margin-bottom: 4px;
    }

    input[type="password"] {
      width: 100%;
      padding: 6px 9px;
      border-radius: 10px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background-color: rgba(15, 23, 42, 0.96);
      color: var(--text-main);
      font-size: 0.78rem;
      outline: none;
    }

    input[type="password"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.7);
    }

    .btn-row {
      display: flex;
      gap: 6px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    button {
      border: none;
      border-radius: var(--radius-pill);
      padding: 6px 12px;
      font-size: 0.72rem;
      font-weight: 500;
      cursor: pointer;
      background: rgba(15, 23, 42, 0.98);
      color: var(--text-main);
      border: 1px solid rgba(55, 65, 81, 0.95);
      transition:
        background 120ms ease-out,
        transform 80ms ease-out,
        box-shadow 120ms ease-out,
        border-color 120ms ease-out;
      white-space: nowrap;
    }

    button.primary {
      background: radial-gradient(circle at top left, #3b82f6, #1d4ed8);
      border-color: rgba(96, 165, 250, 0.95);
      box-shadow:
        0 0 0 1px rgba(59, 130, 246, 0.55),
        0 14px 30px rgba(37, 99, 235, 0.6);
    }

    button.primary:hover {
      filter: brightness(1.06);
      transform: translateY(-0.5px);
    }

    button.secondary {
      background: rgba(15, 23, 42, 0.96);
    }

    button.secondary:hover {
      background: rgba(30, 64, 175, 0.45);
      border-color: rgba(96, 165, 250, 0.7);
    }

    button.danger {
      background: rgba(127, 29, 29, 0.9);
      border-color: rgba(248, 113, 113, 0.9);
      color: #fee2e2;
    }

    button.danger:hover {
      background: rgba(185, 28, 28, 0.96);
    }

    button:active {
      transform: translateY(0.4px) scale(0.99);
      box-shadow: none;
    }

    button:disabled {
      opacity: 0.45;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .groups-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 220px;
      overflow-y: auto;
      padding-right: 2px;
    }

    .group-row {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 5px 7px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.95);
      cursor: pointer;
    }

    .group-row.active {
      border-color: rgba(96, 165, 250, 0.95);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.7);
      background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.25), #020617);
    }

    .group-name {
      flex: 1;
      font-size: 0.78rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .group-row button {
      padding: 4px 10px;
      font-size: 0.7rem;
    }

    .controls-section {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(31, 41, 55, 0.9);
    }

    .controls-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }

    .controls-header span {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .slider-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
    }

    .slider-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      width: 60px;
    }

    .slider-value {
      font-size: 0.7rem;
      color: var(--text-muted);
      width: 40px;
      text-align: right;
    }

    input[type="range"] {
      flex: 1;
      accent-color: #60a5fa;
    }

    .color-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 6px;
    }

    input[type="color"] {
      width: 38px;
      height: 22px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      padding: 0;
      background: transparent;
      cursor: pointer;
    }

    .scene-row {
      display: flex;
      gap: 6px;
      margin-top: 6px;
      align-items: center;
    }

    .scene-row select {
      flex: 1;
      padding: 6px 9px;
      border-radius: 10px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background-color: rgba(15, 23, 42, 0.96);
      color: var(--text-main);
      font-size: 0.78rem;
      outline: none;
    }

    .scene-row select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.7);
    }

    .footer {
      margin-top: 8px;
      font-size: 0.65rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      opacity: 0.8;
    }

    .footer span {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="card-inner">
      <div class="header-row">
        <div>
          <h1>Govee Groups</h1>
          <p class="subtitle">SameModeGroup · Quick control</p>
        </div>
        <div class="badge-api">Cloud API v1</div>
      </div>

      <div class="section">
        <div class="section-header">
          <div class="section-title">Configuration</div>
          <div class="pill" id="groupsSummary">No groups loaded</div>
        </div>
        <label for="apiKeyInput">Govee API Key</label>
        <input id="apiKeyInput" type="password" autocomplete="off" />
        <div class="btn-row">
          <button id="saveKeyBtn" class="primary">Save</button>
          <button id="reloadGroupsBtn" class="secondary">Reload groups</button>
          <button id="clearConfigBtn" class="danger">Clear</button>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <div class="section-title">Groups</div>
          <div class="pill" id="activeGroupLabel">No active group</div>
        </div>

        <div id="groupsContainer" class="groups-list">
          <div style="font-size:0.75rem;color:var(--text-muted);">
            No groups yet. Save API key, then use “Reload groups”.
          </div>
        </div>

        <div class="controls-section">
          <div class="controls-header">
            <span>Active group controls</span>
            <span id="capSummary">–</span>
          </div>

          <div class="slider-row">
            <div class="slider-label">Brightness</div>
            <input id="brightnessRange" type="range" min="1" max="100" value="100" />
            <span class="slider-value" id="brightnessValue">100%</span>
          </div>
          <div class="btn-row" style="margin-top:4px;">
            <button id="setBrightnessBtn" class="secondary" style="flex:1;">Set brightness</button>
            <button id="refreshStateBtn" class="secondary">Refresh</button>
          </div>

          <div class="color-row">
            <div class="slider-label">Color</div>
            <input id="colorPicker" type="color" value="#ffffff" />
            <button id="setColorBtn" class="secondary" style="flex:1;">Set color</button>
          </div>

          <div class="scene-row">
            <select id="sceneSelect">
              <option value="">No scenes loaded</option>
            </select>
            <button id="loadScenesBtn" class="secondary">Scenes</button>
            <button id="applySceneBtn" class="secondary">Apply</button>
          </div>
        </div>
      </div>

      <div class="footer">
        <span id="statusText">Idle.</span>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://openapi.api.govee.com/router/api/v1";
    const ENDPOINTS = {
      devices: API_BASE + "/user/devices",
      control: API_BASE + "/device/control",
      state: API_BASE + "/device/state",
      scenes: API_BASE + "/device/scenes"
    };

    const STORAGE_KEYS = {
      apiKey: "goveeApiKey",
      selectedGroup: "goveeSelectedGroup",
      devicesSnapshot: "goveeDevicesSnapshot"  // shared with full widget if present
    };

    const apiKeyInput = document.getElementById("apiKeyInput");
    const saveKeyBtn = document.getElementById("saveKeyBtn");
    const reloadGroupsBtn = document.getElementById("reloadGroupsBtn");
    const clearConfigBtn = document.getElementById("clearConfigBtn");
    const groupsContainer = document.getElementById("groupsContainer");
    const groupsSummary = document.getElementById("groupsSummary");
    const activeGroupLabel = document.getElementById("activeGroupLabel");
    const capSummary = document.getElementById("capSummary");
    const statusText = document.getElementById("statusText");

    const brightnessRange = document.getElementById("brightnessRange");
    const brightnessValue = document.getElementById("brightnessValue");
    const setBrightnessBtn = document.getElementById("setBrightnessBtn");
    const refreshStateBtn = document.getElementById("refreshStateBtn");
    const colorPicker = document.getElementById("colorPicker");
    const setColorBtn = document.getElementById("setColorBtn");
    const sceneSelect = document.getElementById("sceneSelect");
    const loadScenesBtn = document.getElementById("loadScenesBtn");
    const applySceneBtn = document.getElementById("applySceneBtn");

    let groupsCache = {};  // key: "device|sku" -> device obj
    let scenesCache = {};  // key: "device|sku" -> [{name,value}]
    let activeGroupKey = "";

    function setStatus(message, isError) {
      statusText.textContent = message;
      statusText.style.color = isError ? "#f97373" : "#9ca3af";
      statusText.style.borderColor = isError
        ? "rgba(248,113,113,0.9)"
        : "rgba(55,65,81,0.9)";
    }

    function uuidFallback() {
      if (window.crypto && window.crypto.randomUUID) {
        return window.crypto.randomUUID();
      }
      return String(Date.now()) + "-" + Math.floor(Math.random() * 1000000000);
    }

    function getApiKey() {
      return apiKeyInput.value.trim();
    }

    function saveApiKeyToStorage() {
      const key = getApiKey();
      if (!key) {
        setStatus("Enter an API key before saving.", true);
        return;
      }
      try {
        localStorage.setItem(STORAGE_KEYS.apiKey, key);
        setStatus("API key saved.", false);
      } catch (e) {
        setStatus("Cannot save API key: " + e.message, true);
      }
    }

    function loadApiKeyFromStorage() {
      try {
        const key = localStorage.getItem(STORAGE_KEYS.apiKey);
        if (key) {
          apiKeyInput.value = key;
          setStatus("API key loaded from local storage.", false);
        } else {
          setStatus("Idle.", false);
        }
      } catch (e) {
        setStatus("Idle.", false);
      }
    }

    function clearConfig() {
      try {
        localStorage.removeItem(STORAGE_KEYS.apiKey);
        localStorage.removeItem(STORAGE_KEYS.selectedGroup);
      } catch (e) {
        // ignore
      }
      apiKeyInput.value = "";
      groupsCache = {};
      scenesCache = {};
      activeGroupKey = "";
      groupsContainer.innerHTML =
        '<div style="font-size:0.75rem;color:var(--text-muted);">Config cleared. Save API key, then reload groups.</div>';
      groupsSummary.textContent = "No groups loaded";
      activeGroupLabel.textContent = "No active group";
      capSummary.textContent = "–";
      setStatus("Config cleared.", false);
    }

    function groupKey(dev) {
      return dev.device + "|" + dev.sku;
    }

    function getActiveGroup() {
      if (!activeGroupKey) return null;
      return groupsCache[activeGroupKey] || null;
    }

    function persistActiveGroup() {
      if (!activeGroupKey) return;
      try {
        localStorage.setItem(STORAGE_KEYS.selectedGroup, activeGroupKey);
      } catch (e) {
        // ignore
      }
    }

    function restoreActiveGroup() {
      try {
        const key = localStorage.getItem(STORAGE_KEYS.selectedGroup);
        if (key && groupsCache[key]) {
          setActiveGroup(key);
        }
      } catch (e) {
        // ignore
      }
    }

    function describeCapabilities(dev) {
      if (!dev || !Array.isArray(dev.capabilities)) return "Capabilities unknown";
      const caps = dev.capabilities;
      const names = [];

      if (caps.some(c => c.type === "devices.capabilities.on_off")) {
        names.push("power");
      }
      if (caps.some(c =>
        c.type === "devices.capabilities.range" &&
        c.instance === "brightness"
      )) {
        names.push("brightness");
      }
      if (caps.some(c =>
        c.type === "devices.capabilities.color_setting" &&
        c.instance === "colorRgb"
      )) {
        names.push("color");
      }
      if (caps.some(c =>
        c.type === "devices.capabilities.dynamic_scene" &&
        c.instance === "lightScene"
      )) {
        names.push("scenes");
      }

      return names.length ? names.join(" · ") : "Capabilities unknown";
    }

    function getRangeInfo(dev, instanceName) {
      if (!dev || !Array.isArray(dev.capabilities)) return null;
      for (let i = 0; i < dev.capabilities.length; i++) {
        const c = dev.capabilities[i];
        if (
          c.type === "devices.capabilities.range" &&
          c.instance === instanceName &&
          c.parameters &&
          c.parameters.range
        ) {
          return c.parameters.range;
        }
      }
      return null;
    }

    function hasCapability(dev, type, instance) {
      if (!dev || !Array.isArray(dev.capabilities)) return false;
      return dev.capabilities.some(c => c.type === type && c.instance === instance);
    }

    function applyActiveGroupGating() {
      const dev = getActiveGroup();
      if (!dev) {
        brightnessRange.disabled = true;
        setBrightnessBtn.disabled = true;
        colorPicker.disabled = true;
        setColorBtn.disabled = true;
        sceneSelect.disabled = true;
        loadScenesBtn.disabled = true;
        applySceneBtn.disabled = true;
        refreshStateBtn.disabled = true;
        capSummary.textContent = "–";
        return;
      }

      capSummary.textContent = describeCapabilities(dev);

      const brightRange = getRangeInfo(dev, "brightness");
      if (brightRange) {
        brightnessRange.min = String(brightRange.min || 1);
        brightnessRange.max = String(brightRange.max || 100);
        brightnessRange.disabled = false;
        setBrightnessBtn.disabled = false;
      } else {
        brightnessRange.disabled = true;
        setBrightnessBtn.disabled = true;
      }

      const hasColor = hasCapability(
        dev,
        "devices.capabilities.color_setting",
        "colorRgb"
      );
      colorPicker.disabled = !hasColor;
      setColorBtn.disabled = !hasColor;

      const hasScene = hasCapability(
        dev,
        "devices.capabilities.dynamic_scene",
        "lightScene"
      );
      sceneSelect.disabled = !hasScene;
      loadScenesBtn.disabled = !hasScene;
      applySceneBtn.disabled = !hasScene;

      refreshStateBtn.disabled = false;
    }

    function renderGroupsList() {
      const entries = Object.values(groupsCache);
      if (!entries.length) {
        groupsContainer.innerHTML =
          '<div style="font-size:0.75rem;color:var(--text-muted);">No SameModeGroup groups found. Configure groups in Govee Home and reload.</div>';
        groupsSummary.textContent = "0 groups";
        activeGroupLabel.textContent = "No active group";
        applyActiveGroupGating();
        return;
      }

      entries.sort((a, b) => {
        const nameA = (a.deviceName || a.device || "").toLowerCase();
        const nameB = (b.deviceName || b.device || "").toLowerCase();
        if (nameA < nameB) return -1;
        if (nameA > nameB) return 1;
        return 0;
      });

      groupsContainer.innerHTML = "";
      entries.forEach(dev => {
        const key = groupKey(dev);
        const row = document.createElement("div");
        row.className = "group-row";
        row.dataset.key = key;

        const name = document.createElement("div");
        name.className = "group-name";
        name.textContent = dev.deviceName || dev.device || "Unnamed group";

        const btnOn = document.createElement("button");
        btnOn.textContent = "On";
        btnOn.className = "primary";
        btnOn.addEventListener("click", function (e) {
          e.stopPropagation();
          sendControlToDevice(dev, {
            type: "devices.capabilities.on_off",
            instance: "powerSwitch",
            value: 1
          });
        });

        const btnOff = document.createElement("button");
        btnOff.textContent = "Off";
        btnOff.className = "secondary";
        btnOff.addEventListener("click", function (e) {
          e.stopPropagation();
          sendControlToDevice(dev, {
            type: "devices.capabilities.on_off",
            instance: "powerSwitch",
            value: 0
          });
        });

        row.appendChild(name);
        row.appendChild(btnOn);
        row.appendChild(btnOff);

        row.addEventListener("click", function () {
          setActiveGroup(key);
        });

        groupsContainer.appendChild(row);
      });

      groupsSummary.textContent = entries.length + " group" + (entries.length === 1 ? "" : "s");

      if (!activeGroupKey && entries[0]) {
        setActiveGroup(groupKey(entries[0]));
      } else {
        highlightActiveRow();
        applyActiveGroupGating();
      }
    }

    function highlightActiveRow() {
      const rows = groupsContainer.querySelectorAll(".group-row");
      rows.forEach(r => {
        if (r.dataset.key === activeGroupKey) {
          r.classList.add("active");
        } else {
          r.classList.remove("active");
        }
      });
    }

    function setActiveGroup(key) {
      if (!groupsCache[key]) return;
      activeGroupKey = key;
      const dev = getActiveGroup();
      activeGroupLabel.textContent =
        "Active: " + (dev.deviceName || dev.device || key);
      highlightActiveRow();
      applyActiveGroupGating();
      persistActiveGroup();
    }

    async function loadGroups() {
      const apiKey = getApiKey();
      if (!apiKey) {
        setStatus("Enter your Govee API key first.", true);
        return;
      }

      setStatus("Loading groups…", false);
      groupsContainer.innerHTML =
        '<div style="font-size:0.75rem;color:var(--text-muted);">Loading…</div>';

      try {
        const res = await fetch(ENDPOINTS.devices, {
          method: "GET",
          headers: {
            "Govee-API-Key": apiKey
          }
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error("HTTP " + res.status + " " + text);
        }

        const data = await res.json();

        if (typeof data.code === "number" && data.code !== 200) {
          const msg = data.msg || data.message || "Unknown error";
          throw new Error("API error code " + data.code + ": " + msg);
        }

        let devices = [];
        if (Array.isArray(data.data)) {
          devices = data.data;
        } else if (data.data && Array.isArray(data.data.devices)) {
          devices = data.data.devices;
        } else if (Array.isArray(data.payload)) {
          devices = data.payload;
        } else if (data.payload && Array.isArray(data.payload.devices)) {
          devices = data.payload.devices;
        }

        const groups = devices.filter(d => d.sku === "SameModeGroup");

        groupsCache = {};
        groups.forEach(g => {
          groupsCache[groupKey(g)] = g;
        });

        renderGroupsList();
        setStatus("Groups loaded (" + groups.length + ").", false);
      } catch (e) {
        console.error(e);
        groupsContainer.innerHTML =
          '<div style="font-size:0.75rem;color:var(--text-muted);">Error loading groups.</div>';
        groupsSummary.textContent = "Load error";
        setStatus("Group load failed: " + e.message, true);
      }
    }

    async function sendControlToDevice(dev, capability) {
      const apiKey = getApiKey();
      if (!apiKey) {
        setStatus("Enter your Govee API key first.", true);
        return;
      }

      setStatus("Sending command…", false);

      try {
        const res = await fetch(ENDPOINTS.control, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Govee-API-Key": apiKey
          },
          body: JSON.stringify({
            requestId: uuidFallback(),
            payload: {
              device: dev.device,
              sku: dev.sku,
              capability: capability
            }
          })
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error("HTTP " + res.status + " " + text);
        }

        const data = await res.json();
        if (typeof data.code === "number" && data.code !== 200) {
          const msg = data.msg || data.message || "Unknown error";
          throw new Error("API error code " + data.code + ": " + msg);
        }

        setStatus("Command sent successfully.", false);
      } catch (e) {
        console.error(e);
        setStatus("Command failed: " + e.message, true);
      }
    }

    async function refreshStateForActiveGroup() {
      const apiKey = getApiKey();
      if (!apiKey) {
        setStatus("Enter your Govee API key first.", true);
        return;
      }
      const dev = getActiveGroup();
      if (!dev) {
        setStatus("Select an active group first.", true);
        return;
      }

      setStatus("Refreshing state…", false);

      try {
        const res = await fetch(ENDPOINTS.state, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Govee-API-Key": apiKey
          },
          body: JSON.stringify({
            requestId: uuidFallback(),
            payload: {
              device: dev.device,
              sku: dev.sku
            }
          })
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error("HTTP " + res.status + " " + text);
        }

        const data = await res.json();
        if (typeof data.status === "number" && data.status !== 200) {
          const msg = data.msg || data.message || "Unknown error";
          throw new Error("API status " + data.status + ": " + msg);
        }

        const payload = data.payload || {};
        const caps = Array.isArray(payload.capabilities)
          ? payload.capabilities
          : [];

        const brightCap = caps.find(c =>
          c.type === "devices.capabilities.range" &&
          c.instance === "brightness" &&
          c.state &&
          typeof c.state.value === "number"
        );
        if (brightCap) {
          const v = Math.round(brightCap.state.value);
          brightnessRange.value = String(v);
          brightnessValue.textContent = v + "%";
        }

        const colorCap = caps.find(c =>
          c.type === "devices.capabilities.color_setting" &&
          c.instance === "colorRgb" &&
          c.state &&
          typeof c.state.value === "number"
        );
        if (colorCap) {
          const rgbInt = colorCap.state.value;
          const r = (rgbInt >> 16) & 255;
          const g = (rgbInt >> 8) & 255;
          const b = rgbInt & 255;
          const hex =
            "#" +
            [r, g, b]
              .map(x => x.toString(16).padStart(2, "0"))
              .join("");
          colorPicker.value = hex;
        }

        const powerCap = caps.find(c =>
          c.type === "devices.capabilities.on_off" &&
          c.instance === "powerSwitch" &&
          c.state &&
          typeof c.state.value !== "undefined"
        );

        if (powerCap) {
          const val = powerCap.state.value ? "On" : "Off";
          setStatus("State: " + val + " · refreshed.", false);
        } else {
          setStatus("State refreshed.", false);
        }
      } catch (e) {
        console.error(e);
        setStatus("State refresh failed: " + e.message, true);
      }
    }

    async function loadScenesForActiveGroup() {
      const apiKey = getApiKey();
      if (!apiKey) {
        setStatus("Enter your Govee API key first.", true);
        return;
      }
      const dev = getActiveGroup();
      if (!dev) {
        setStatus("Select an active group first.", true);
        return;
      }

      const key = groupKey(dev);
      if (scenesCache[key] && scenesCache[key].length) {
        populateSceneSelect(scenesCache[key]);
        setStatus("Scenes loaded from cache.", false);
        return;
      }

      setStatus("Loading scenes…", false);

      try {
        const res = await fetch(ENDPOINTS.scenes, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Govee-API-Key": apiKey
          },
          body: JSON.stringify({
            requestId: uuidFallback(),
            payload: {
              device: dev.device,
              sku: dev.sku
            }
          })
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error("HTTP " + res.status + " " + text);
        }

        const data = await res.json();
        if (typeof data.status === "number" && data.status !== 200) {
          const msg = data.msg || data.message || "Unknown error";
          throw new Error("API status " + data.status + ": " + msg);
        }

        let caps = [];
        if (Array.isArray(data.data)) {
          if (data.data[0] && Array.isArray(data.data[0].capabilities)) {
            caps = data.data[0].capabilities;
          }
        } else if (data.data && Array.isArray(data.data.capabilities)) {
          caps = data.data.capabilities;
        }

        const scenes = [];
        caps.forEach(c => {
          if (
            c.type === "devices.capabilities.dynamic_scene" &&
            c.instance === "lightScene" &&
            c.parameters &&
            Array.isArray(c.parameters.options)
          ) {
            c.parameters.options.forEach(opt => {
              if (typeof opt.value !== "undefined") {
                scenes.push({
                  name: opt.name || String(opt.value),
                  value: opt.value
                });
              }
            });
          }
        });

        scenesCache[key] = scenes;
        populateSceneSelect(scenes);

        if (!scenes.length) {
          setStatus("No scenes reported for this group.", true);
        } else {
          setStatus("Scenes loaded (" + scenes.length + ").", false);
        }
      } catch (e) {
        console.error(e);
        populateSceneSelect([]);
        setStatus("Scene load failed: " + e.message, true);
      }
    }

    function populateSceneSelect(scenes) {
      if (!scenes || !scenes.length) {
        sceneSelect.innerHTML = '<option value="">No scenes available</option>';
        return;
      }
      sceneSelect.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Select scene…";
      sceneSelect.appendChild(placeholder);

      scenes.forEach(s => {
        const opt = document.createElement("option");
        opt.value = String(s.value);
        opt.textContent = s.name + " (" + s.value + ")";
        sceneSelect.appendChild(opt);
      });
    }

    function hexToRgbInt(hex) {
      if (!hex) return 0;
      if (hex.charAt(0) === "#") {
        hex = hex.slice(1);
      }
      if (hex.length === 3) {
        hex =
          hex.charAt(0) +
          hex.charAt(0) +
          hex.charAt(1) +
          hex.charAt(1) +
          hex.charAt(2) +
          hex.charAt(2);
      }
      const n = parseInt(hex, 16);
      if (isNaN(n)) return 0;
      return n;
    }

    brightnessRange.addEventListener("input", function () {
      brightnessValue.textContent = brightnessRange.value + "%";
    });

    saveKeyBtn.addEventListener("click", saveApiKeyToStorage);
    clearConfigBtn.addEventListener("click", clearConfig);
    reloadGroupsBtn.addEventListener("click", loadGroups);

    refreshStateBtn.addEventListener("click", refreshStateForActiveGroup);

    setBrightnessBtn.addEventListener("click", function () {
      const dev = getActiveGroup();
      if (!dev) {
        setStatus("Select an active group first.", true);
        return;
      }
      const rangeInfo = getRangeInfo(dev, "brightness");
      let val = parseInt(brightnessRange.value, 10) || 1;
      if (rangeInfo) {
        const min = typeof rangeInfo.min === "number" ? rangeInfo.min : 1;
        const max = typeof rangeInfo.max === "number" ? rangeInfo.max : 100;
        val = Math.max(min, Math.min(max, val));
      } else {
        val = Math.max(1, Math.min(100, val));
      }
      sendControlToDevice(dev, {
        type: "devices.capabilities.range",
        instance: "brightness",
        value: val
      });
    });

    setColorBtn.addEventListener("click", function () {
      const dev = getActiveGroup();
      if (!dev) {
        setStatus("Select an active group first.", true);
        return;
      }
      if (!hasCapability(dev, "devices.capabilities.color_setting", "colorRgb")) {
        setStatus("Active group does not support colorRgb.", true);
        return;
      }
      const hex = colorPicker.value || "#ffffff";
      const rgbInt = hexToRgbInt(hex);
      sendControlToDevice(dev, {
        type: "devices.capabilities.color_setting",
        instance: "colorRgb",
        value: rgbInt
      });
    });

    loadScenesBtn.addEventListener("click", loadScenesForActiveGroup);

    applySceneBtn.addEventListener("click", function () {
      const dev = getActiveGroup();
      if (!dev) {
        setStatus("Select an active group first.", true);
        return;
      }
      const valRaw = sceneSelect.value;
      if (!valRaw) {
        setStatus("Select a scene first.", true);
        return;
      }
      let val;
      if (/^-?\d+$/.test(valRaw)) {
        val = parseInt(valRaw, 10);
      } else {
        val = valRaw;
      }
      sendControlToDevice(dev, {
        type: "devices.capabilities.dynamic_scene",
        instance: "lightScene",
        value: val
      });
    });

    (function init() {
      loadApiKeyFromStorage();

      try {
        const snapshotRaw = localStorage.getItem(STORAGE_KEYS.devicesSnapshot);
        if (snapshotRaw) {
          const snapshot = JSON.parse(snapshotRaw);
          if (Array.isArray(snapshot) && snapshot.length) {
            const groups = snapshot.filter(d => d.sku === "SameModeGroup");
            groupsCache = {};
            groups.forEach(g => {
              groupsCache[groupKey(g)] = g;
            });
            renderGroupsList();
            restoreActiveGroup();
            applyActiveGroupGating();
            setStatus("Groups loaded from cache. Use Reload groups to refresh.", false);
            return;
          }
        }
      } catch (e) {
        // ignore
      }

      applyActiveGroupGating();
    })();
  </script>
</body>
</html>
